<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PoggioFace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .subject-card {
            margin-bottom: 20px;
        }
        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .image-item {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 10px;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }
        .image-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Dashboard PoggioFace</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Soggetti</h5>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSubjectModal">
                            Aggiungi Soggetto
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="subjects-list" class="row">
                            <!-- I soggetti saranno generati qui dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Dettagli Soggetto</h5>
                    </div>
                    <div class="card-body" id="subject-details">
                        <p class="text-muted">Seleziona un soggetto per visualizzare i dettagli</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Aggiungi Soggetto -->
    <div class="modal fade" id="addSubjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Aggiungi Nuovo Soggetto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-subject-form">
                        <div class="mb-3">
                            <label for="subject-name" class="form-label">Nome Soggetto</label>
                            <input type="text" class="form-control" id="subject-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="subject-image" class="form-label">Immagine</label>
                            <input type="file" class="form-control" id="subject-image" accept="image/*" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="save-subject-btn">Salva</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Rinomina Soggetto -->
    <div class="modal fade" id="renameSubjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rinomina Soggetto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="rename-subject-form">
                        <input type="hidden" id="old-subject-name">
                        <div class="mb-3">
                            <label for="new-subject-name" class="form-label">Nuovo Nome</label>
                            <input type="text" class="form-control" id="new-subject-name" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="rename-subject-btn">Rinomina</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Aggiungi Foto -->
    <div class="modal fade" id="addImageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Aggiungi Immagine per <span id="add-image-subject-name"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-image-form">
                        <input type="hidden" id="image-subject-name">
                        <div class="mb-3">
                            <label for="new-subject-image" class="form-label">Immagine</label>
                            <input type="file" class="form-control" id="new-subject-image" accept="image/*" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="add-image-btn">Aggiungi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        // Ottenere tutti i soggetti all'avvio
        document.addEventListener('DOMContentLoaded', function() {
            fetchSubjects();
            
            // Event listener per salvare un nuovo soggetto
            document.getElementById('save-subject-btn').addEventListener('click', addSubject);
            
            // Event listener per rinominare un soggetto
            document.getElementById('rename-subject-btn').addEventListener('click', renameSubject);
            
            // Event listener per aggiungere un'immagine a un soggetto
            document.getElementById('add-image-btn').addEventListener('click', addSubjectImage);
        });
        
        // Funzione per ottenere tutti i soggetti
        let cachedSubjects = null;
        let lastSubjectFetch = 0;
        const CACHE_EXPIRY = 30000; // 30 secondi

        // Funzione per ottenere tutti i soggetti
        function fetchSubjects() {
            const now = Date.now();
            
            // Se abbiamo una cache valida, usala
            if (cachedSubjects && (now - lastSubjectFetch < CACHE_EXPIRY)) {
                renderSubjects(cachedSubjects);
                return;
            }
            
            // Mostra un indicatore di caricamento
            const subjectsList = document.getElementById('subjects-list');
            subjectsList.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Caricamento...</span></div></div>';
            
            fetch('/api/subjects')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Errore HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    cachedSubjects = data;
                    lastSubjectFetch = now;
                    renderSubjects(data);
                })
                .catch(error => {
                    console.error('Errore nel recupero dei soggetti:', error);
                    
                    // Se abbiamo una cache (anche scaduta), usala come fallback
                    if (cachedSubjects) {
                        console.log('Utilizzo dei dati in cache come fallback');
                        renderSubjects(cachedSubjects);
                        
                        // Mostra un avviso che stiamo usando dati in cache
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning mb-3';
                        alertDiv.textContent = 'Impossibile connettersi al server. Visualizzazione dati dall\'ultima sessione.';
                        subjectsList.prepend(alertDiv);
                    } else {
                        subjectsList.innerHTML = '<div class="alert alert-danger">Errore nel recupero dei soggetti. Riprova pi√π tardi.</div>';
                    }
                });
        }


        // Funzione separata per renderizzare i soggetti dalla cache o dal server
        function renderSubjects(data) {
            const subjectsList = document.getElementById('subjects-list');
            subjectsList.innerHTML = '';
            
            if (data.subjects && data.subjects.length > 0) {
                data.subjects.forEach(subject => {
                    const subjectCard = document.createElement('div');
                    subjectCard.className = 'col-md-6 subject-card';
                    subjectCard.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${subject}</h5>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary view-subject" data-subject="${subject}">Visualizza</button>
                                    <button class="btn btn-sm btn-warning rename-subject" data-subject="${subject}">Rinomina</button>
                                    <button class="btn btn-sm btn-danger delete-subject" data-subject="${subject}">Elimina</button>
                                </div>
                            </div>
                        </div>
                    `;
                    subjectsList.appendChild(subjectCard);
                });
                
                // Aggiungi event listeners ai bottoni
                document.querySelectorAll('.view-subject').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const subject = this.getAttribute('data-subject');
                        fetchSubjectImages(subject);
                    });
                });
                
                document.querySelectorAll('.rename-subject').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const subject = this.getAttribute('data-subject');
                        document.getElementById('old-subject-name').value = subject;
                        document.getElementById('new-subject-name').value = subject;
                        new bootstrap.Modal(document.getElementById('renameSubjectModal')).show();
                    });
                });
                
                document.querySelectorAll('.delete-subject').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const subject = this.getAttribute('data-subject');
                        if (confirm(`Sei sicuro di voler eliminare il soggetto "${subject}" e tutte le sue immagini?`)) {
                            deleteSubject(subject);
                        }
                    });
                });
            } else {
                subjectsList.innerHTML = '<p class="text-muted">Nessun soggetto trovato</p>';
            }
        }

        // Funzione per recuperare i soggetti con retry
        function fetchSubjectsWithRetry(maxRetries = 3) {
            let retries = 0;
            
            function attempt() {
                fetch('/api/subjects')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Errore HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Gestione normale dei dati
                        const subjectsList = document.getElementById('subjects-list');
                        subjectsList.innerHTML = '';
                        
                        // Resto del codice...
                    })
                    .catch(error => {
                        console.error('Errore nel recupero dei soggetti:', error);
                        
                        if (retries < maxRetries) {
                            retries++;
                            const waitTime = Math.pow(2, retries) * 1000; // backoff esponenziale
                            console.log(`Tentativo ${retries}/${maxRetries} fra ${waitTime/1000} secondi...`);
                            
                            setTimeout(attempt, waitTime);
                        } else {
                            alert('Errore nel recupero dei soggetti dopo multipli tentativi.');
                        }
                    });
            }
            
            attempt();
        }
        
        // Funzione per ottenere le immagini di un soggetto
        function fetchSubjectImages(subject) {
            fetch(`/api/subjects/${subject}/images`)
                .then(response => response.json())
                .then(data => {
                    const subjectDetails = document.getElementById('subject-details');
                    subjectDetails.innerHTML = '';
                    
                    const detailsHeader = document.createElement('div');
                    detailsHeader.innerHTML = `
                        <h4>${subject}</h4>
                        <div class="d-flex justify-content-between mb-3">
                            <button class="btn btn-success add-image" data-subject="${subject}">Aggiungi Foto</button>
                        </div>
                        <hr>
                    `;
                    subjectDetails.appendChild(detailsHeader);
                    
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    
                    if (data.faces && data.faces.length > 0) {
                        data.faces.forEach(face => {
                            const imageDiv = document.createElement('div');
                            imageDiv.className = 'image-item';
                            imageDiv.innerHTML = `
                                <img src="/api/images/${face.image_id}" alt="${subject}">
                                <button class="image-delete" data-image-id="${face.image_id}">√ó</button>
                            `;
                            imageContainer.appendChild(imageDiv);
                        });
                    } else {
                        imageContainer.innerHTML = '<p class="text-muted">Nessuna immagine trovata per questo soggetto</p>';
                    }
                    
                    subjectDetails.appendChild(imageContainer);
                    
                    // Event listener per aggiungere un'immagine
                    document.querySelector('.add-image').addEventListener('click', function() {
                        const subject = this.getAttribute('data-subject');
                        document.getElementById('image-subject-name').value = subject;
                        document.getElementById('add-image-subject-name').textContent = subject;
                        new bootstrap.Modal(document.getElementById('addImageModal')).show();
                    });
                    
                    // Event listener per eliminare un'immagine
                    document.querySelectorAll('.image-delete').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const imageId = this.getAttribute('data-image-id');
                            if (confirm('Sei sicuro di voler eliminare questa immagine?')) {
                                deleteImage(imageId, subject);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Errore nel recupero delle immagini del soggetto:', error);
                    alert('Errore nel recupero delle immagini del soggetto. Controlla la console per i dettagli.');
                });
        }
        
        // Funzione per aggiungere un nuovo soggetto
        function addSubject() {
            const subjectName = document.getElementById('subject-name').value;
            const subjectImage = document.getElementById('subject-image').files[0];
            
            if (!subjectName || !subjectImage) {
                alert('Per favore, compila tutti i campi richiesti.');
                return;
            }
            
            const formData = new FormData();
            formData.append('subject', subjectName);
            formData.append('image', subjectImage);
            
            // Mostra un indicatore di caricamento
            const saveButton = document.getElementById('save-subject-btn');
            saveButton.disabled = true;
            saveButton.textContent = 'Caricamento...';
            
            fetch('/api/subjects', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                alert('Soggetto aggiunto con successo!');
                
                // Aggiungi il soggetto appena creato alla lista senza ricaricare la pagina
                const newSubjectCard = document.createElement('div');
                newSubjectCard.className = 'col-md-6 subject-card';
                newSubjectCard.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${subjectName}</h5>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary view-subject" data-subject="${subjectName}">Visualizza</button>
                                <button class="btn btn-sm btn-warning rename-subject" data-subject="${subjectName}">Rinomina</button>
                                <button class="btn btn-sm btn-danger delete-subject" data-subject="${subjectName}">Elimina</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Aggiungi la nuova card del soggetto al top della lista
                const subjectsList = document.getElementById('subjects-list');
                subjectsList.prepend(newSubjectCard);
                
                // Aggiungi gli event listeners ai nuovi bottoni
                newSubjectCard.querySelector('.view-subject').addEventListener('click', function() {
                    const subject = this.getAttribute('data-subject');
                    fetchSubjectImages(subject);
                });
                
                newSubjectCard.querySelector('.rename-subject').addEventListener('click', function() {
                    const subject = this.getAttribute('data-subject');
                    document.getElementById('old-subject-name').value = subject;
                    document.getElementById('new-subject-name').value = subject;
                    new bootstrap.Modal(document.getElementById('renameSubjectModal')).show();
                });
                
                newSubjectCard.querySelector('.delete-subject').addEventListener('click', function() {
                    const subject = this.getAttribute('data-subject');
                    if (confirm(`Sei sicuro di voler eliminare il soggetto "${subject}" e tutte le sue immagini?`)) {
                        deleteSubject(subject);
                    }
                });
                
                // Ripristina il form e chiudi il modal
                document.getElementById('add-subject-form').reset();
                new bootstrap.Modal(document.getElementById('addSubjectModal')).hide();
            })
            .catch(error => {
                console.error('Errore nell\'aggiunta del soggetto:', error);
                alert('Errore nell\'aggiunta del soggetto. Controlla la console per i dettagli.');
            })
            .finally(() => {
                // Ripristina il bottone
                saveButton.disabled = false;
                saveButton.textContent = 'Salva';
            });
        }


        
        // Funzione per rinominare un soggetto
        function renameSubject() {
            const oldSubject = document.getElementById('old-subject-name').value;
            const newSubject = document.getElementById('new-subject-name').value;
            
            if (!newSubject) {
                alert('Per favore, inserisci un nuovo nome per il soggetto.');
                return;
            }
            
            fetch(`/api/subjects/${oldSubject}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject: newSubject
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                alert('Soggetto rinominato con successo!');
                new bootstrap.Modal(document.getElementById('renameSubjectModal')).hide();
                fetchSubjects();
            })
            .catch(error => {
                console.error('Errore nella modifica del nome del soggetto:', error);
                alert('Errore nella modifica del nome del soggetto. Controlla la console per i dettagli.');
            });
        }
        
        // Funzione per aggiungere un'immagine a un soggetto
        function addSubjectImage() {
            const subject = document.getElementById('image-subject-name').value;
            const image = document.getElementById('new-subject-image').files[0];
            
            if (!image) {
                alert('Per favore, seleziona un\'immagine.');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', image);
            
            fetch(`/api/subjects/${subject}/images`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                alert('Immagine aggiunta con successo!');
                document.getElementById('add-image-form').reset();
                new bootstrap.Modal(document.getElementById('addImageModal')).hide();
                fetchSubjectImages(subject);
            })
            .catch(error => {
                console.error('Errore nell\'aggiunta dell\'immagine:', error);
                alert('Errore nell\'aggiunta dell\'immagine. Controlla la console per i dettagli.');
            });
        }
        
        // Funzione per eliminare un'immagine
        function deleteImage(imageId, subject) {
            const imageElement = document.querySelector(`[data-image-id="${imageId}"]`).parentNode;
            imageElement.style.opacity = '0.5'; // Rendi l'immagine semi-trasparente durante l'eliminazione
            
            fetch(`/api/images/${imageId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Rimuovi direttamente l'elemento dalla DOM senza ricaricare i dati
                imageElement.remove();
                
                // Mostra un messaggio di successo
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success mt-2';
                successMsg.textContent = 'Immagine eliminata con successo';
                document.getElementById('subject-details').prepend(successMsg);
                
                // Rimuovi il messaggio dopo 3 secondi
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            })
            .catch(error => {
                console.error('Errore nell\'eliminazione dell\'immagine:', error);
                imageElement.style.opacity = '1'; // Ripristina l'opacit√†
                alert('Errore nell\'eliminazione dell\'immagine: ' + error);
            });
        }
        
        // Funzione per eliminare un soggetto
        function deleteSubject(subject) {
            if (!confirm(`Sei sicuro di voler eliminare "${subject}"?`)) return;

            fetch(`/api/subjects/${encodeURIComponent(subject)}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
            })
            .then(() => {
                // Ricarica completa per pulire lo stato
                window.location.reload();
            })
            .catch(error => {
                console.error('Errore eliminazione:', error);
                alert(`Errore durante l'eliminazione: ${error.message}`);
            });
        }
    </script>
</body>
</html>